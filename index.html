const dns = require('dns');

addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request))
})

async function handleRequest(request) {

  const url = new URL(request.url);
  if (url.pathname.startsWith('/resolve')) {

    const hostname = url.searchParams.get('name');

    if (!hostname) {
      return new Response('Missing name parameter', {status: 400});
    }

    let ip;

    try {
      const result = await new Promise((resolve, reject) => {
        dns.resolve4(hostname, (err, addresses) => {
          if (err) { return reject(err); }
          resolve(addresses); 
        });
      });
      ip = result[0];
    } catch (err) {
      return new Response(err.message, {status: 500});
    }

    return new Response(ip);
  
  } else {
    
    return new Response('Use /resolve?name={hostname}');
  
  }

}
